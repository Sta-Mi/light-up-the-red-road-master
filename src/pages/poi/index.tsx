import { Image, Input, Map, View } from "@tarojs/components";
import { AtAccordion, AtList, AtListItem } from 'taro-ui';
import Taro from "@tarojs/taro";
import React, { Component } from "react";
import amapFile from "../../libs/amap-wx";
import config from "../../libs/config";
import markerChecked from "../../assets/marker_checked.png";
import markerUnChecked from "../../assets/marker.png";
import getUserLocationIcon from "../../assets/get-location.png";
import exhibitionTotalData from "../../data/exhibition_total_data.json";
import redPathData from "../../data/red_path_data.json";
import onmarkerIdByUser from "../../data/onmarkerIdByUser.json";
import "./index.scss";
import GlobalMenu from "../../components/GlobalMenu";


//ÂÖ®Â±Äwx
let myAmapFun;
//ËíôÂ±ÇÂÖ®Â±ÄID
//let currentId=-1;


let markersData : any[];

interface State {
  markers: any[],
  poisData: any[],
  latitude: number,
  longitude: number,
  textData: {},
  currentId: number,
  city: string,
  scale: number,
  distanceFromMe: number,
  exhibitionImage: string,
  exhibitionName: string,
  exhibitionAddress: string,
  exhibitionNote: string,
  exhibitionTime: string,
  bottomDistance: string,
  maskDisplay: string,
  detailInfoDisplay: string,
  isSearch: boolean,
  polyline: any[],
  openAccordion: boolean
}
export default class PoiPage extends Component<{}, State>  {
  $instance = Taro.getCurrentInstance();
  state : State = {
    markers: [],
    poisData: [],
    latitude: 0,
    longitude: 0,
    textData: {},
    currentId: -1,
    city: '',
    scale: 5,
    distanceFromMe: 0,
    exhibitionImage: '',
    exhibitionName: '',
    exhibitionAddress: '',
    exhibitionNote: '',
    exhibitionTime: '',
    bottomDistance: '97px',
    maskDisplay: 'none',
    detailInfoDisplay: 'none',
    isSearch: false,
    polyline: [],
    openAccordion: false
  };

  //ÂàùÂßãÂåñ
  componentWillMount = () => {
    // ÂàùÂßãÂåñÈ´òÂæ∑Âú∞Âõæ
    const key = config.Config.key;
    myAmapFun = new amapFile.AMapWX({key: key});

  }


  // È°µÈù¢ÂàùÂßãÂä†ËΩΩÊó∂
  componentDidMount() {
    let that = this;

    //A->B
    const simplifiedExhibitions = exhibitionTotalData.map(item => {
      return {
        id: item.id,
        exhibitionName: item.exhibitionName,
        latitude: item.exhibitionLatitude,
        longitude: item.exhibitionLongitude
      };
    });
    markersData = simplifiedExhibitions;

    markersData.forEach(marker=> {
      if(onmarkerIdByUser.includes(marker.id)){
        //Ë°®Á§∫ÂΩìÂâçÁî®Êà∑ÁöÑËøô‰∏™Ê†áËÆ∞ÁÇπÂ∑≤ÁªèÊâìËøáÂç°‰∫Ü
        marker.iconPath = markerChecked;
      }else{
        marker.iconPath = markerUnChecked;
      }
      marker.height = 22;
      marker.width = 22;
      marker.callout = {
        content: 'üì∑' + marker.exhibitionName, // ÊòæÁ§∫POIÂêçÁß∞ÂíåÂ±ïÈ¶ÜÂõæÁâá B
        color: '#000000',
        fontSize: 14,
        borderRadius: 10,
        bgColor: '#ffffff',
        padding: 10,
        display: 'ALWAYS', // Ê∞îÊ≥°ÂßãÁªàÊòæÁ§∫ todo1.Ëé∑ÂèñÂú∞ÂõæÁº©ÊîæÁöÑscale 2.ÂΩìscale>=16Êó∂ÂÜçÊòæÁ§∫
        textAlign: 'center'
      };
    });

    //ÁªòÂà∂Á∫øË∑Ø
    that.portraitPath('');

    //Ëé∑ÂèñÊü•ËØ¢Â≠óÁ¨¶‰∏≤
    //Âõ†‰∏∫inputtipsÁöÑbindSearch()ÂáΩÊï∞‰º†ÈÄí‰∫ÜË∑ØÁî±ÂèÇÊï∞
    const paramsFromInputtips = this.$instance.router?.params;
    if (paramsFromInputtips&&paramsFromInputtips.searchKeywords) {
      console.log('ÊâßË°å‰∫Ü')
      that.searchMarkerShowPoiList(paramsFromInputtips);
    }


  }


  // ÁÇπÂáªÊ†áËÆ∞ÂêéËß¶Âèë‰∫ã‰ª∂
  makertap = (e) => {
    let that = this;
    const id = e.markerId;
    that.setState({
      currentId: id,
    },()=>{
      that.changeMarkerColor();
    });
  };
  // MapÁªÑ‰ª∂ÈîôËØØÊó∂
  onmakerError = (e) => {
    console.error(e);
    Taro.showToast({
      title: 'Âú∞ÂõæÂä†ËΩΩÂá∫Èîô',
      icon: 'error'
    })
  };

  // Ëé∑ÂèñÁî®Êà∑‰ΩçÁΩÆ
  getUserLocation = () =>{
    let that = this;
    Taro.getLocation({
      type: 'gcj02',
      success: function(res) {
        that.setState({
          latitude: res.latitude,
          longitude: res.longitude,
        });
        // todo Êõ¥Êñ∞Áî®Êà∑ÊúÄÊñ∞ÁöÑ‰ΩçÁΩÆ(ÂèÇÊï∞ÔºöÁªèÂ∫¶ÔºåÁ∫¨Â∫¶ÔºåÁî®Êà∑id)
      },
      fail: function(){
        Taro.showToast({
          title: 'ËØ∑ÊâìÂºÄÂÆö‰Ωç',
          icon: 'error'
        })
      }
    })
  }

  // Ê†πÊçÆÁî®Êà∑ÁÇπÂáªÂêéÂºπÂá∫ÂºπÊ°Ü
  changeMarkerColor = ()=> {
    let that = this;
    //iÊòØexhibitionid
    const exhibitionItem = exhibitionTotalData.filter(item => item.id == that.state.currentId)[0];
    that.changeSelectMarker(true);
    that.setState(
      {
        markers: markersData,
        exhibitionImage: exhibitionItem.exhibitionImage,
        exhibitionName: exhibitionItem.exhibitionName,
        exhibitionAddress: exhibitionItem.exhibitionAddress,
        exhibitionNote: exhibitionItem.exhibitionNote,
        exhibitionTime: exhibitionItem.exhibitionStartTime + ' - ' + exhibitionItem.exhibitionFinishTime,
        bottomDistance: '156px',
        maskDisplay: 'block',
        detailInfoDisplay: 'flex',
      }
    );
  }

  //Â∞Üid=iÁöÑmarkerÊ†∑ÂºèÊîπ‰∏∫ÈÄâ‰∏≠Áä∂ÊÄÅ or Êú™ÈÄâ‰∏≠Áä∂ÊÄÅ
  changeSelectMarker = (isSelectStatus) => {
    let that = this;
    markersData.forEach(marker => {
      if (marker.id === that.state.currentId && isSelectStatus) {
        // Change marker to selected state
        marker.callout = {
          content: 'üì∑' + marker.exhibitionName,
          color: '#000000',
          fontSize: 20,
          borderRadius: 10,
          borderWidth: 3,
          bgColor: '#ffffff',
          padding: 10,
          display: 'ALWAYS',
          textAlign: 'center'
        };
      } else {
        // Change marker to unselected state
        marker.callout = {
          content: 'üì∑' + marker.exhibitionName,
          color: '#000000',
          fontSize: 14,
          borderRadius: 10,
          borderWidth: -1,
          bgColor: '#ffffff',
          padding: 10,
          display: 'ALWAYS',
          textAlign: 'center'
        };
      }
    });
  }


  //ÁÇπÂáªÊêúÁ¥¢Ê°ÜËøõË°åÊêúÁ¥¢
  bindInput = (e) => {
    const { latitude, longitude } = e.currentTarget.dataset;
    let url = '/pages/inputtips/index';

    if (latitude && longitude) {
      url += `?lonlat=${longitude},${latitude}`;
    }

    Taro.redirectTo({
      url
    });
  }

  // ‰ªéÊêúÁ¥¢È°µÈù¢ËøîÂõûÂêéÔºåÂ¶ÇÊûúÂú®exhibitionTotal‰∏≠ÊâæÂà∞‰∫ÜÔºåÂàôÂºπÂá∫Âë®ËæπÂ±ïÈ¶ÜÂàóË°® + ÈÄâ‰∏≠Áä∂ÊÄÅ
  searchMarkerShowPoiList= (paramsFromInputtips) =>{
    let searchMarkerId = -1;
    let that = this;
    //todo Ê†πÊçÆ‰º†ÈÄíËøáÊù•ÁöÑkeywords Êü•ËØ¢ÊÄªÊï∞ÁªÑÁöÑname===keywordsÂæóÂà∞ÂîØ‰∏Ä‰∏Ä‰∏™ÂØπË±°Ôºå‰º†ÂÖ•iÊâßË°åchangeMarkerColor()ÊïàÊûúÁ±ª‰ººÔºåÂè™‰∏çËøáÂ∫ï‰∏ãÊòØÂàóË°®
    const exhibitionSecrchItem = exhibitionTotalData.filter(item=>{
      if(item.exhibitionName === paramsFromInputtips.searchKeywords){
        that.setState({
          currentId: item.id, //Áî®‰∫éÁÇπÂáªËíôÂ±ÇÊó∂ÔºåÁü•ÈÅìÊõ¥ÊîπÂì™‰∏™markerÁöÑÊ†∑Âºè
        });
        searchMarkerId = item.id;
        return item;
      }
      return false;
    })

    if (exhibitionSecrchItem.length!=0) {

      //ÊâßË°åËé∑ÂèñÂë®Ëæπ‰ø°ÊÅØ
      let params = {
        querykeywords: paramsFromInputtips.searchKeywords,
        success: function (data) {
          // Êõ¥Êñ∞‰∏≠ÂøÉÁÇπÔºåÈÄâ‰∏≠Áä∂ÊÄÅÔºåÊòæÁ§∫ÂàóË°®
          that.changeSelectMarker( true);
          if(data.poisData.length===0){
            that.setState({
              isSearch: false,
              bottomDistance: "156px",
              exhibitionImage: exhibitionSecrchItem[0].exhibitionImage,
              exhibitionName: exhibitionSecrchItem[0].exhibitionName,
              exhibitionAddress: exhibitionSecrchItem[0].exhibitionAddress,
              exhibitionNote: exhibitionSecrchItem[0].exhibitionNote,
              exhibitionTime: exhibitionSecrchItem[0].exhibitionStartTime + ' - ' + exhibitionSecrchItem[0].exhibitionFinishTime,
            })
          }else {
            that.setState({
              poisData: data.poisData,
              isSearch: true,
              bottomDistance: "52vh",
            })
          }
          that.setState({
            scale: 16,
            markers: markersData,
            latitude: exhibitionSecrchItem[0].exhibitionLatitude,
            longitude: exhibitionSecrchItem[0].exhibitionLongitude,
            maskDisplay: "block",
            detailInfoDisplay: "flex",
          });
          console.log("ÂΩìÂâçÂë®ËæπÊôØÁÇπÊòØÔºö",data.poisData);
        },
        fail: function (info) {
          console.log("poiÂáΩÊï∞‰∏≠Ëé∑ÂèñÂ§±Ë¥•Ôºö",info);
        },
      };
      myAmapFun.getPoiAround(params);
    } else {
      Taro.showToast({
        title: "ÂæÖÊî∂ÂΩï",
        icon: "error",
      });
    }
  }

  //ÈöêËóèÂºπÁ™óÂíåËíôÂ±Ç+ Êõ¥Êîπmarker‰∏∫Êú™ÈÄâ‰∏≠Áä∂ÊÄÅ
  hideMaskAndDetailInfo = () =>{
    let that = this;
    that.changeSelectMarker(false); //Êõ¥Êîπmarker‰∏∫Êú™ÈÄâ‰∏≠Áä∂ÊÄÅ
    that.setState({
      bottomDistance: '97px',
      maskDisplay: 'none',
      detailInfoDisplay: 'none',
      markers: markersData, //ÔºÅÔºÅÔºÅÔºÅÊ≥®ÊÑèÊõ¥Êñ∞ÁªëÂÆöÂà∞ËßÜÂõæ‰∏≠ÁöÑmapÁöÑmarkerÔºåÊ†∑ÂºèÊâçËÉΩÊîπÂèòÔºÅÔºÅÔºÅ
      isSearch: false,
    })
  }


  //ÁªòÂà∂Ë∑ØÁ∫øÂõæ
  portraitPath = (pathName:string)=>{
    let that = this;
    let waypoints: string = '';
    let destination: string ='';
    if(pathName != ''){
      redPathData.filter(item => item.pathName === pathName).map(item => {
        let pathExhibitionIdList = item.pathExhibitionIdList;
        pathExhibitionIdList.map((item, index) => {
          let xiabiao = item-1;
          if(index === pathExhibitionIdList.length - 1){
            //ÊúÄÂêé‰∏ÄÈ°π
            destination += `${exhibitionTotalData[xiabiao].exhibitionLongitude},${exhibitionTotalData[xiabiao].exhibitionLatitude}`;
          }else {
            waypoints += `${exhibitionTotalData[xiabiao].exhibitionLongitude},${exhibitionTotalData[xiabiao].exhibitionLatitude};`;
          }
        })
      });
      myAmapFun.getDrivingRoute({
        origin: `${this.state.longitude},${this.state.latitude}`,// Ëµ∑ÁÇπÊàëÁöÑÂÆö‰Ωç

        waypoints: waypoints,// ÈÄîÂæÑÁÇπ
        destination: destination,//ÁªàÁÇπ
        success: function(data){
          let points : any[] = [];
          if(data.paths && data.paths[0] && data.paths[0].steps){
            let steps = data.paths[0].steps;
            for(let i = 0; i < steps.length; i++){
              let poLen = steps[i].polyline.split(';');
              for(let j = 0;j < poLen.length; j++){
                points.push({
                  longitude: poLen[j].split(',')[0],
                  latitude: poLen[j].split(',')[1]
                });
              }
            }
          }
          let mid = parseInt((points.length / 2).toString());
          that.setState({
            polyline: [{
              points: points,
              color: "#ff0000",
              width: 6
            }],
            longitude: points[mid].longitude,
            latitude: points[mid].latitude,
            markers: markersData
          });

        },
        fail: function(info){
          console.log("getDrivingRouteÂáΩÊï∞Êä•ÈîôÔºö",info);
        }
      })
    }else {
      //Ëé∑ÂèñÁî®Êà∑ÂΩìÂâç‰ΩçÁΩÆ
      that.getUserLocation();
      that.setState({
        markers: markersData
      })
    }
  }

  //ÊòæÁ§∫‰∏ãÊãâÂàóË°®
  showPathNames = () =>{
    if(this.state.openAccordion){
      this.setState({
        openAccordion: false
      })
    }else {
      this.setState({
        openAccordion: true
      })
      //Êõ¥ÊîπÊ†∑Âºè

    }
  }

  //Ëé∑ÂèñÁÇπÂáªÁöÑpathName
  getPathName = (e) =>{
    let that = this;
    let pathName = e._relatedInfo.anchorTargetText;
    console.log(e._relatedInfo.anchorTargetText);
    //‰º†ÈÄíÁªôÂáΩÊï∞ÈáçÊñ∞Âä†ËΩΩÂú∞Âõæ
    //
    //ÁªòÂà∂Á∫øË∑Ø
    that.portraitPath(pathName);
    //Ëá™Âä®ÂÖ≥Èó≠
    that.setState({
      openAccordion: false
    })
  }

  render() {
    return (
      <View>
        <View className="poiPage">
        {/*ÊêúÁ¥¢Ê°Ü*/}
        <View className="section">
          <Input
            className="section_input"
            data-city={this.state.city}
            data-longitude={this.state.longitude}
            data-latitude={this.state.latitude}
            // onTouchStart={this.bindInput.bind(this)}
            onClick={this.bindInput.bind(this)}
            placeholder="ÊêúÁ¥¢"
          />
        </View>
        {/*Á†îÂ≠¶Ë∑ØÁ∫ø*/}
        <View className="top_float_box">
          <AtAccordion
            open={this.state.openAccordion}
            onClick={this.showPathNames.bind(this)}
            title='Á†îÂ≠¶‰πãË∑Ø'
          >
            <AtList hasBorder={false}>
              {redPathData.length > 0 ? (
                redPathData.map(item => (
                  <AtListItem
                    key={item.id} // Á°Æ‰øùÊØè‰∏™È°πÈÉΩÊúâÂîØ‰∏ÄÁöÑ key
                    onClick={this.getPathName} // ‰º†ÈÄíË∑ØÂæÑÂêçÁß∞
                    title={item.pathName}
                    arrow='right'
                    thumb={item.pathImageUrl} // ÂÅáËÆæ imageUrl ÊòØÊï∞ÁªÑÂØπË±°‰∏≠ÁöÑÂ±ûÊÄß
                  />
                ))
              ) : (
                <AtListItem title='Ê≤°ÊúâÂèØÁî®ÁöÑË∑ØÂæÑ' />
              )}
            </AtList>
          </AtAccordion>
        </View>
        {/*Âú∞Âõæ and ËíôÂ±Ç*/}
        <View className="map_container">
          <View className="mask" style={{ display: this.state.maskDisplay }} onClick={this.hideMaskAndDetailInfo}></View>

          <Map
            className="map"
            id="map"
            longitude={this.state.longitude}
            latitude={this.state.latitude}
            scale={this.state.scale}
            showLocation
            markers={this.state.markers}
            polyline={this.state.polyline}
            onMarkerTap={this.makertap.bind(this)}
            onError={this.onmakerError.bind(this)}
          />
        </View>
        {/*ÂÆö‰ΩçÂõæÊ†á and markerÂç°Áâá or markerÂë®ËæπÊôØÁÇπÂàóË°®*/}
        <View className="bottom_float_box">
          <Image
            style={{ width: '27px', height: '27px', bottom: this.state.bottomDistance }}
            className="get_location_icon"
            mode="scaleToFill"
            src={getUserLocationIcon}
            onClick={this.getUserLocation}
          />

          <View style={{ display: this.state.detailInfoDisplay }}>
            {this.state.isSearch ? (
              <View className="detail_info search_view">
                {this.state.poisData.map((item, index) => (
                  <View key={index} className="search_item">
                    <View className="bottom_content">
                      <View className="content_header">
                        <View className="info_title">{//@ts-ignore
                          item.name}</View>
                        <View className="info_address">{//@ts-ignore
                          item.type}</View>
                        <View className="info_note">{//@ts-ignore
                          item.tel}</View>
                        <View className="info_distance">{//@ts-ignore
                          (item.distance / 1000).toFixed(2)}km</View>
                      </View>
                      <View className="content_footer">
                        <View>{//@ts-ignore
                          item.address}</View>
                      </View>
                    </View>
                  </View>
                ))}
              </View>
            ) : (
              <View className="detail_info">
                <View className="image_container">
                  <Image
                    style={{ width: '100%', height: '100%' }}
                    className="exhibition_image"
                    mode="scaleToFill"
                    src={this.state.exhibitionImage}
                  />
                </View>
                <View className="bottom_content">
                  <View className="content_header">
                    <View className="info_title">{this.state.exhibitionName}</View>
                    <View className="info_note">{this.state.exhibitionNote}</View>
                    <View className="info_distance">{this.state.exhibitionTime}</View>
                  </View>
                  <View className="content_footer">
                    <View>{this.state.exhibitionAddress}</View>
                  </View>
                </View>
              </View>
            )}
          </View>
        </View>
      </View>
        <GlobalMenu />
      </View>
    );
  }
}
